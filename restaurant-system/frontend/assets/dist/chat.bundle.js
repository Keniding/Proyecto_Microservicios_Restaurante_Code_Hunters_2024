(()=>{"use strict";function e(t){return e="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},e(t)}function t(e,t){for(var o=0;o<t.length;o++){var s=t[o];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,n(s.key),s)}}function n(t){var n=function(t){if("object"!=e(t)||!t)return t;var n=t[Symbol.toPrimitive];if(void 0!==n){var o=n.call(t,"string");if("object"!=e(o))return o;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(t);return"symbol"==e(n)?n:n+""}var o=function(){return e=function e(t,n){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.url=t,this.userId=n,this.socket=null,this.onMessageCallback=null,this.onErrorCallback=null,this.onConnectCallback=null,this.reconnectAttempts=0,this.maxReconnectAttempts=5,this.messageHandlers={auth_required:this.handleAuthRequired.bind(this),auth_success:this.handleAuthSuccess.bind(this),auth_failed:this.handleAuthFailed.bind(this),chat:this.handleChat.bind(this),error:this.handleError.bind(this),initial_messages:this.handleInitialMessages.bind(this),more_messages:this.handleMoreMessages.bind(this),chat_list:this.handleChatList.bind(this)}},(n=[{key:"handleAuthRequired",value:function(){this.authenticate()}},{key:"handleAuthSuccess",value:function(){console.log("Autenticación exitosa"),this.onConnectCallback&&this.onConnectCallback()}},{key:"handleAuthFailed",value:function(e){console.error("Autenticación fallida:",e.error),this.onErrorCallback&&this.onErrorCallback("Error de autenticación: "+e.error)}},{key:"handleChat",value:function(e){this.onMessageCallback&&this.onMessageCallback(e)}},{key:"handleError",value:function(e){this.onErrorCallback&&this.onErrorCallback(e.message)}},{key:"handleInitialMessages",value:function(e){this.onMessageCallback&&this.onMessageCallback(e)}},{key:"handleMoreMessages",value:function(e){this.onMessageCallback&&this.onMessageCallback(e)}},{key:"handleChatList",value:function(e){this.onMessageCallback&&this.onMessageCallback(e)}},{key:"connect",value:function(){var e=this;this.socket=new WebSocket(this.url),this.socket.onopen=function(){console.log("WebSocket conexión abierta"),e.reconnectAttempts=0,e.authenticate()},this.socket.onmessage=function(t){var n=JSON.parse(t.data);console.log("Mensaje recibido:",n),e.messageHandlers[n.type]?e.messageHandlers[n.type](n):console.log("Mensaje no manejado:",n)},this.socket.onerror=function(t){console.error("WebSocket Error:",t),e.onErrorCallback&&e.onErrorCallback("Error de conexión WebSocket")},this.socket.onclose=function(){console.log("WebSocket conexión cerrada"),e.reconnect()}}},{key:"reconnect",value:function(){var e=this;this.reconnectAttempts<this.maxReconnectAttempts?(this.reconnectAttempts++,console.log("Intento de reconexión ".concat(this.reconnectAttempts,"...")),setTimeout((function(){return e.connect()}),5e3)):(console.error("Máximo número de intentos de reconexión alcanzado"),this.onErrorCallback&&this.onErrorCallback("No se pudo reconectar al servidor"))}},{key:"authenticate",value:function(){console.log("Enviando autenticación para user_id:",this.userId),this.socket.send(JSON.stringify({type:"auth",user_id:this.userId}))}},{key:"sendMessage",value:function(e,t){if(this.socket&&this.socket.readyState===WebSocket.OPEN){var n=JSON.stringify({type:"chat",chat_id:e,user_id:this.userId,content:t});console.log("Enviando mensaje:",n),this.socket.send(n)}else console.error("WebSocket no está abierto. Estado actual:",this.socket?this.socket.readyState:"no socket"),this.onErrorCallback&&this.onErrorCallback("No se puede enviar el mensaje: la conexión está cerrada")}},{key:"getMessages",value:function(e,t,n){if(this.socket&&this.socket.readyState===WebSocket.OPEN){var o=JSON.stringify({type:"get_messages",chat_id:e,page:t,limit:n});console.log("Solicitando historial de mensajes:",o),this.socket.send(o)}else console.error("WebSocket no está abierto. Estado actual:",this.socket?this.socket.readyState:"no socket"),this.onErrorCallback&&this.onErrorCallback("No se puede solicitar el historial de mensajes: la conexión está cerrada")}},{key:"getChats",value:function(e){if(this.socket&&this.socket.readyState===WebSocket.OPEN){var t=JSON.stringify({type:"get_chats",user_id:this.userId});console.log("Solicitando lista de chats:",t),this.socket.send(t),this.on("chat_list",e)}else console.error("WebSocket no está abierto. Estado actual:",this.socket?this.socket.readyState:"no socket"),this.onErrorCallback&&this.onErrorCallback("No se puede solicitar la lista de chats: la conexión está cerrada")}},{key:"on",value:function(e,t){this.messageHandlers[e]=t}},{key:"onMessage",value:function(e){this.onMessageCallback=e}},{key:"onError",value:function(e){this.onErrorCallback=e}},{key:"onConnect",value:function(e){this.onConnectCallback=e}},{key:"disconnect",value:function(){this.socket&&this.socket.close()}}])&&t(e.prototype,n),Object.defineProperty(e,"prototype",{writable:!1}),e;var e,n}();document.addEventListener("DOMContentLoaded",(function(){var e=document.getElementById("message-input"),t=document.getElementById("send-button"),n=document.getElementById("chat-messages"),s=document.getElementById("error-message"),a=document.getElementById("chat-options"),c=localStorage.getItem("user_id"),i=null,r=1,l=4,u=new o("ws://localhost:8081",c);function d(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1;i?(console.log("Solicitando mensajes para la página:",e),u.getMessages(i,e,l)):console.log("No se ha seleccionado un chat")}function h(e){var t=document.createElement("div");t.className="message";var n="Invalid Date";if(e.created_at){var o=new Date(e.created_at);isNaN(o)||(n=o.toLocaleString())}var s=e.username?e.username:"Unknown User",a=e.user_id?e.user_id:"Unknown Id";t.innerHTML='\n            <div class="message-header">\n                <strong>'.concat(s,'</strong>\n                <span class="message-date">').concat(n,'</span>\n            </div>\n            <div class="message-content">').concat(e.content,"</div>\n        ");var c,i,r,l,u={};return t.style.background=(u[c=a]||(u[c]=(i=c,l=(r=1e4*Math.sin(i))-Math.floor(r),"hsl(".concat(360*l,", ").concat(50,"%, ").concat(85,"%)"))),u[c]),t}function g(e){console.log("Mostrando mensaje:",e);var t=h(e);n.appendChild(t),n.scrollTop=n.scrollHeight}function m(e){console.error("Error:",e),s?(s.textContent=e,s.style.display="block",setTimeout((function(){s.style.display="none"}),5e3)):alert("Error: "+e)}function k(){var t=e.value.trim();t&&i&&(u.sendMessage(i,t),e.value="",d())}u.on("auth_success",(function(e){console.log("Autenticación exitosa:",e),u.getChats((function(e){console.log(e);var t=e.chats;console.log(t),a.innerHTML="";var o=document.createElement("option");o.textContent="Selecciona un chat",o.value="",a.appendChild(o),t.forEach((function(e){var t=document.createElement("option");t.textContent=e.name,t.value=e.id,a.appendChild(t)})),a.onchange=function(){i=a.value,r=1,i&&d(),""===a.value&&(n.innerHTML="")}}))})),u.on("message_sent",(function(e){console.log("Mensaje enviado con éxito:",e)})),u.on("new_message",(function(e){g(e)})),u.onMessage((function(e){switch(console.log("Mensaje recibido:",e),e.type){case"chat":g(e);break;case"error":m(e.message);break;case"initial_messages":!function(e){if(console.log("Recibidos mensajes iniciales:",e),console.log("Número de mensajes recibidos:",e.messages.length),n.innerHTML="",e.messages.sort((function(e,t){return new Date(e.created_at)-new Date(t.created_at)})),e.messages.forEach((function(e,t){console.log("Mensaje ".concat(t+1,":"),e),g(e)})),n.scrollTop=n.scrollHeight,e.messages.length===l){var t=document.createElement("button");t.textContent="Cargar más mensajes",t.id="load-more-messages",t.onclick=function(){d(++r)},n.appendChild(t)}console.log("Mensajes iniciales mostrados en la interfaz")}(e);break;case"more_messages":!function(e){console.log("Recibidos más mensajes:",e),console.log("Número de mensajes adicionales recibidos:",e.messages.length),e.messages.sort((function(e,t){return new Date(e.created_at)-new Date(t.created_at)})),e.messages.reverse().forEach((function(e,t){console.log("Mensaje adicional ".concat(t+1,":"),e);var o=h(e);n.insertBefore(o,n.firstChild)}));var t=document.getElementById("load-more-messages");e.messages.length<l&&t&&t.remove(),console.log("Mensajes adicionales mostrados en la interfaz")}(e);break;default:console.log("Tipo de mensaje no manejado:",e.type),m("Tipo de mensaje no manejado.")}})),t.addEventListener("click",k),e.addEventListener("keypress",(function(e){"Enter"===e.key&&k()})),window.addEventListener("beforeunload",(function(){u.disconnect()})),u.connect()}))})();